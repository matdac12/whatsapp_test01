<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/style.css?v=15">
</head>
<body>
    <div class="container-fluid h-100">
        <!-- Analytics Stats Bar -->
        <div class="stats-bar bg-light border-bottom py-2 px-3">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-auto me-auto">
                        <h6 class="mb-0 text-muted">Dashboard</h6>
                    </div>
                    <div class="col-auto">
                        <a href="/analytics" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-bar-chart"></i> Analytics
                        </a>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex gap-3">
                            <!-- Messages 24h KPI -->
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="bi bi-chat-square-dots-fill"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-value" id="kpi-messages">-</div>
                                    <div class="kpi-label">Messaggi (24h)</div>
                                </div>
                            </div>

                            <!-- Active Conversations KPI -->
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="bi bi-people-fill"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-value" id="kpi-active">-</div>
                                    <div class="kpi-label">Attivi (24h)</div>
                                </div>
                            </div>

                            <!-- Response Rate KPI -->
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="bi bi-graph-up-arrow"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-value" id="kpi-response">-</div>
                                    <div class="kpi-label">Tasso Risposta</div>
                                </div>
                            </div>

                            <!-- Profile Completion KPI -->
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="bi bi-person-vcard-fill"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-value" id="kpi-completion">-</div>
                                    <div class="kpi-label">Profili Completi</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row h-100" style="height: calc(100vh - 80px) !important;">
            <!-- Left Sidebar - Contact List -->
            <div class="col-md-4 col-lg-3 border-end p-0 contacts-sidebar h-100">
                <div class="bg-light p-3 border-bottom">
                    <h5 class="mb-2">Conversazioni</h5>
                    <input type="text" id="contactsSearch" class="form-control form-control-sm contacts-search" placeholder="Cerca nome, azienda, telefonoâ€¦" autocomplete="off">
                </div>
                <div class="contacts-list" id="contactsList">
                    <!-- Contacts will be loaded here -->
                </div>
            </div>
            
            <!-- Right Panel - Chat -->
            <div class="col-md-8 col-lg-9 p-0 d-flex flex-column chat-panel h-100">
                <!-- Chat Header -->
                <div class="chat-header bg-light p-3 border-bottom" id="chatHeader">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-0">
                                <span id="contactName" style="cursor: pointer;" onclick="if(currentPhone) openEditModal()">Seleziona una conversazione</span>
                                <i class="bi bi-pencil-square ms-2" style="font-size: 0.8em; cursor: pointer; display: none;" id="editIcon" onclick="openEditModal()"></i>
                            </h6>
                            <small class="text-muted" id="contactInfo"></small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="form-check form-switch mb-0" title="Quando attivo, le risposte AI vengono salvate come bozze">
                                <input class="form-check-input" type="checkbox" id="manualToggle" onchange="onManualToggleChange()">
                                <label class="form-check-label" for="manualToggle">Manuale</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div class="flex-grow-1 overflow-auto p-3 messages-container" id="messagesContainer">
                    <div class="text-center text-muted mt-5">
                        <p>Seleziona una conversazione dalla lista</p>
                    </div>
                </div>
                
                <!-- AI Draft Panel (Manuale) -->
                <div id="draftPanelContainer" class="draft-panel p-3 border-top" style="display: none; background: var(--panel-soft);"></div>

                <!-- Slash Command Dropdown -->
                <div id="slashCommandMenu" class="slash-command-menu" style="display: none;"></div>

                <!-- Message Input -->
                <div class="border-top p-3 message-input-container" id="messageInputContainer" style="display: none;">
                    <div class="input-group">
                        <textarea rows="1" class="form-control" id="messageInput" placeholder="Scrivi un messaggioâ€¦ (usa / per comandi rapidi)"></textarea>
                        <button class="btn btn-success" id="sendButton" onclick="sendMessage()" disabled>Invia</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Contact Modal -->
    <div class="modal fade" id="editContactModal" tabindex="-1" aria-labelledby="editContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editContactModalLabel">Modifica Contatto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="contact-meta mb-3">
                        <div class="meta-item">
                            <i class="bi bi-telephone"></i>
                            <span class="meta-label">Numero</span>
                            <span class="meta-value">+<span id="editPhoneText"></span></span>
                        </div>
                    </div>
                    <form id="editContactForm">
                        <div class="mb-3">
                            <label for="editName" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="editName" placeholder="Inserisci nome">
                        </div>
                        <div class="mb-3">
                            <label for="editLastName" class="form-label">Cognome</label>
                            <input type="text" class="form-control" id="editLastName" placeholder="Inserisci cognome">
                        </div>
                        <div class="mb-3">
                            <label for="editCompany" class="form-label">Azienda (Ragione Sociale)</label>
                            <input type="text" class="form-control" id="editCompany" placeholder="Inserisci azienda">
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" placeholder="Inserisci email">
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Note</label>
                            <textarea class="form-control" id="editNotes" rows="3" placeholder="Note per questo contatto (visibili solo agli operatori)"></textarea>
                        </div>
                    </form>
                    <div class="alert alert-success d-none" id="saveSuccess">
                        <i class="bi bi-check-circle"></i> Contatto salvato con successo!
                    </div>
                    <div class="alert alert-danger d-none" id="saveError">
                        <i class="bi bi-exclamation-circle"></i> Errore nel salvataggio.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveContact()" id="saveButton">
                        <span id="saveButtonText">Salva</span>
                        <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPhone = null;
        let conversations = {};
        let contactsQuery = '';
        let composerInitialized = false;
        // Incremental update state
        const lastKnownTsByPhone = {};
        const renderedCountByPhone = {};
        const lastDayKeyByPhone = {};
        // Draft panel UI state to preserve regen section visibility and text
        let draftPanelState = { regenOpen: false, regenNotes: '', isTyping: false, isRegenerating: false };
        // Slash command state
        let slashCommandActive = false;
        let slashCommands = [];
        let selectedCommandIndex = -1;

        function initComposerListeners() {
            if (composerInitialized) {
                console.log('[DEBUG] Composer already initialized, skipping duplicate listener');
                return;
            }
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            if (!input || !sendBtn) return;

            console.log('[DEBUG] Initializing composer listeners (should only happen once)');

            const autoResize = () => {
                // Reset height to measure content
                input.style.height = 'auto';
                const maxH = 160; // px max height
                const minH = 38;  // px min height (1 row)

                // Get the natural content height
                const contentHeight = input.scrollHeight;

                // Clamp between min and max
                const newHeight = Math.max(minH, Math.min(contentHeight, maxH));
                input.style.height = newHeight + 'px';

                // Force scrolling if content exceeds max height
                if (contentHeight > maxH) {
                    input.style.overflowY = 'auto';
                } else {
                    input.style.overflowY = 'hidden';
                }
            };

            input.addEventListener('input', () => {
                const hasText = input.value.trim().length > 0;
                sendBtn.disabled = !hasText;
                autoResize();

                // Check for slash commands
                const text = input.value;
                if (text.startsWith('/') && !text.includes(' ') && !text.includes('\n')) {
                    // User is typing a slash command
                    showSlashCommandMenu(text);
                } else {
                    hideSlashCommandMenu();
                }
            });

            input.addEventListener('keydown', (e) => {
                // Handle slash command navigation
                if (slashCommandActive) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedCommandIndex = Math.min(selectedCommandIndex + 1, slashCommands.length - 1);
                        renderSlashCommandMenu();
                        return;
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedCommandIndex = Math.max(selectedCommandIndex - 1, 0);
                        renderSlashCommandMenu();
                        return;
                    } else if (e.key === 'Enter' && selectedCommandIndex >= 0) {
                        e.preventDefault();
                        selectSlashCommand(slashCommands[selectedCommandIndex]);
                        return;
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        hideSlashCommandMenu();
                        return;
                    }
                }

                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (input.value.trim()) {
                        sendMessage();
                    }
                }
            });

            // Initialize state
            autoResize();
            sendBtn.disabled = true;
            composerInitialized = true;
        }

        // Load analytics summary for stats bar
        function loadAnalytics() {
            fetch('/api/analytics/summary')
                .then(response => response.json())
                .then(data => {
                    // Update KPI values
                    document.getElementById('kpi-messages').textContent = data.messages_24h || 0;
                    document.getElementById('kpi-active').textContent = data.active_24h || 0;
                    document.getElementById('kpi-response').textContent = (data.response_rate || 0) + '%';
                    document.getElementById('kpi-completion').textContent = (data.completion_rate || 0) + '%';
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);
                    // Set fallback values on error
                    document.getElementById('kpi-messages').textContent = '-';
                    document.getElementById('kpi-active').textContent = '-';
                    document.getElementById('kpi-response').textContent = '-';
                    document.getElementById('kpi-completion').textContent = '-';
                });
        }

        // Load conversations on page load
        window.onload = function() {
            // Load initial data
            loadConversations();
            loadAnalytics();

            // Adaptive refresh: 2s when visible, 5s when hidden
            let refreshTimer;

            function startAdaptiveRefresh() {
                const refreshRate = document.hidden ? 5000 : 2000;
                clearInterval(refreshTimer);
                refreshTimer = setInterval(loadConversations, refreshRate);
            }

            // Listen for tab visibility changes
            document.addEventListener('visibilitychange', startAdaptiveRefresh);

            // Start the initial refresh
            startAdaptiveRefresh();

            // Analytics refresh: Every 30 seconds
            setInterval(loadAnalytics, 30000);

            // Status update polling: Every 5 seconds
            setInterval(updateMessageStatuses, 5000);

            initComposerListeners();
            const search = document.getElementById('contactsSearch');
            if (search) {
                search.addEventListener('input', () => {
                    contactsQuery = search.value || '';
                    updateContactsList();
                });
            }
        };
        
        function loadConversations() {
            const contactsList = document.getElementById('contactsList');
            if (contactsList && contactsList.children.length === 0) {
                contactsList.setAttribute('aria-busy', 'true');
                contactsList.innerHTML = renderContactsSkeleton();
            }
            fetch('/api/conversations')
                .then(response => response.json())
                .then(data => {
                    conversations = data;
                    updateContactsList();
                    if (contactsList) contactsList.removeAttribute('aria-busy');
                    if (currentPhone) {
                        const newTs = conversations[currentPhone] ? conversations[currentPhone].last_timestamp : null;

                        // Refresh messages only if new message arrived (incremental append)
                        const hasNewMessage = renderedCountByPhone[currentPhone] != null && newTs && lastKnownTsByPhone[currentPhone] !== newTs;

                        if (hasNewMessage) {
                            loadMessages(currentPhone, false, true); // Incremental append
                        }

                        if (newTs) lastKnownTsByPhone[currentPhone] = newTs;
                        // Refresh settings/draft periodically to reflect new incoming drafts
                        fetchSettingsAndDraft();
                    }
                })
                .catch(error => console.error('Error loading conversations:', error));
        }
        
        // Helpers for contact timestamp sorting/formatting
        function parseTs(ts) {
            if (!ts) return null;
            const s = typeof ts === 'string' ? ts.replace(' ', 'T') : ts;
            const d = new Date(s);
            return isNaN(d) ? null : d;
        }

        function friendlyTimestamp(ts) {
            const dt = parseTs(ts);
            if (!dt) return '';
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const midnight = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
            const time = dt.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            if (midnight.getTime() === today.getTime()) return `Oggi ${time}`;
            if (midnight.getTime() === yesterday.getTime()) return `Ieri ${time}`;
            const sameYear = dt.getFullYear() === now.getFullYear();
            const fmt = new Intl.DateTimeFormat('it-IT', sameYear ? { day: 'numeric', month: 'short' } : { day: 'numeric', month: 'short', year: 'numeric' });
            return fmt.format(dt);
        }

        function updateContactsList() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';

            const entries = Object.entries(conversations);
            const q = (contactsQuery || '').trim().toLowerCase();
            let filtered = q ? entries.filter(([phone, info]) => {
                const dn = (info.name || `+${phone}`).toLowerCase();
                const company = (info.company || '').toLowerCase();
                const email = (info.email || '').toLowerCase();
                const last = (info.last_message || '').toLowerCase();
                return dn.includes(q) || company.includes(q) || email.includes(q) || phone.includes(q) || last.includes(q);
            }) : entries;

            // Sort by most recent last_timestamp descending
            filtered = filtered.sort(([, a], [, b]) => {
                const da = parseTs(a.last_timestamp);
                const db = parseTs(b.last_timestamp);
                const ta = da ? da.getTime() : 0;
                const tb = db ? db.getTime() : 0;
                return tb - ta;
            });

            if (filtered.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'p-3 text-muted';
                empty.textContent = 'Nessun risultato';
                contactsList.appendChild(empty);
                return;
            }

            for (const [phone, info] of filtered) {
                const contact = document.createElement('div');
                contact.className = 'contact-item p-3 border-bottom';
                if (phone === currentPhone) {
                    contact.classList.add('active');
                }

                const displayName = info.name || `+${phone}`;
                const lastMessage = info.last_message || '';
                const timestamp = info.last_timestamp ? friendlyTimestamp(info.last_timestamp) : '';

                contact.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="contact-title">
                            <span class="contact-name">${displayName}</span>
                            ${info.company ? `<small class="text-muted"> - ${info.company}</small>` : ''}
                        </div>
                        <small class="text-muted">${timestamp}</small>
                    </div>
                    <div class="contact-preview text-muted small">${lastMessage}</div>
                `;

                contact.onclick = () => selectContact(phone, contact);
                contactsList.appendChild(contact);
            }
        }
        
        function selectContact(phone, el) {
            currentPhone = phone;
            loadMessages(phone, true);
            
            // Update header
            const info = conversations[phone];
            const hasName = info.name && info.name !== `+${phone}`;
            document.getElementById('contactName').textContent = info.name || `+${phone}`;

            // Only show contactInfo if we have an actual name (to avoid duplicate phone display)
            const contactInfoEl = document.getElementById('contactInfo');
            if (hasName) {
                contactInfoEl.textContent = `+${phone}`;
                contactInfoEl.style.display = 'inline';
            } else {
                contactInfoEl.style.display = 'none';
            }
            document.getElementById('editIcon').style.display = 'inline';
            
            // Show message input
            document.getElementById('messageInputContainer').style.display = 'block';
            // Don't reset composerInitialized - the flag prevents duplicate listeners
            initComposerListeners();
            // Autofocus composer and place caret at end
            const input = document.getElementById('messageInput');
            if (input) {
                setTimeout(() => {
                    input.focus();
                    const val = input.value;
                    input.value = '';
                    input.value = val;
                }, 0);
            }
            
            // Fetch settings and any existing draft
            fetchSettingsAndDraft();

            // Update active contact
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            if (el) el.classList.add('active');
        }
        
        function loadMessages(phone, showSkeleton = false, incremental = false) {
            const container = document.getElementById('messagesContainer');
            if (showSkeleton && container && !incremental) {
                container.setAttribute('aria-busy', 'true');
                container.innerHTML = renderMessagesSkeleton();
            }

            // Fetch text, audio, and image messages in parallel
            Promise.all([
                fetch(`/api/messages/${phone}`).then(r => r.json()),
                fetch(`/api/audio/${phone}`).then(r => r.json()),
                fetch(`/api/images/${phone}`).then(r => r.json())
            ])
                .then(([textMessages, audioMessages, imageMessages]) => {
                    // Tag message types
                    const taggedTextMessages = textMessages.map(msg => ({...msg, type: 'text'}));
                    const taggedAudioMessages = audioMessages.map(msg => ({...msg, type: 'audio', sender: 'user'}));
                    const taggedImageMessages = imageMessages.map(msg => ({...msg, type: 'image', sender: 'user'}));

                    // Merge and sort by timestamp
                    const allMessages = [...taggedTextMessages, ...taggedAudioMessages, ...taggedImageMessages]
                        .sort((a, b) => new Date(a.timestamp || a.created_at) - new Date(b.timestamp || b.created_at));

                    if (incremental && renderedCountByPhone[phone] != null) {
                        appendNewMessages(allMessages);
                    } else {
                        displayMessages(allMessages);
                    }
                })
                .catch(error => console.error('Error loading messages:', error))
                .finally(() => { if (container) container.removeAttribute('aria-busy'); });
        }

        // Skeleton generators
        function renderContactsSkeleton(count = 6) {
            let html = '';
            for (let i = 0; i < count; i++) {
                html += `
                <div class="contact-item p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="skeleton skeleton-line s16 w-50"></div>
                        <div class="skeleton skeleton-line s12 w-25"></div>
                    </div>
                    <div class="skeleton skeleton-line s12 w-75"></div>
                </div>`;
            }
            return html;
        }

        function renderMessagesSkeleton(count = 4) {
            let html = '';
            for (let i = 0; i < count; i++) {
                const align = i % 2 === 0 ? 'received' : 'sent';
                html += `
                <div class="message ${align}">
                    <div class="message-bubble">
                        <div class="skeleton skeleton-line s16 ${align === 'sent' ? 'w-50' : 'w-65'}"></div>
                        <div class="skeleton skeleton-line s12 ${align === 'sent' ? 'w-35' : 'w-50'} mt-2"></div>
                    </div>
                </div>`;
            }
            return html;
        }

        // WhatsApp message formatter
        function formatWhatsAppMessage(text) {
            // First escape HTML to prevent XSS
            const escaped = text.replace(/&/g, '&amp;')
                               .replace(/</g, '&lt;')
                               .replace(/>/g, '&gt;')
                               .replace(/"/g, '&quot;')
                               .replace(/'/g, '&#39;');

            // Apply WhatsApp formatting
            let formatted = escaped;

            // Convert newlines to <br>
            formatted = formatted.replace(/\n/g, '<br>');

            // Convert monospace/code (```text```) - keep as is since backticks are unambiguous
            formatted = formatted.replace(/```([^`]+)```/g, '<code>$1</code>');

            // Improved patterns with word boundaries to avoid false matches
            // Bold (*text*) - must be surrounded by word boundaries or whitespace
            formatted = formatted.replace(/(^|\s)\*([^*\s][^*]*[^*\s]|\S)\*(?=\s|$)/g, '$1<strong>$2</strong>');

            // Italic (_text_) - must be surrounded by word boundaries or whitespace
            formatted = formatted.replace(/(^|\s)_([^_\s][^_]*[^_\s]|\S)_(?=\s|$)/g, '$1<em>$2</em>');

            // Strikethrough (~text~) - must be surrounded by word boundaries or whitespace
            formatted = formatted.replace(/(^|\s)~([^~\s][^~]*[^~\s]|\S)~(?=\s|$)/g, '$1<del>$2</del>');

            return formatted;
        }

        // Render WhatsApp status icon
        function renderStatusIcon(status, sender) {
            // Only show status for bot messages (sent by us)
            if (sender !== 'bot') return '';

            switch(status) {
                case 'sent':
                    return '<span class="status-icon status-sent">âœ“</span>';
                case 'delivered':
                    return '<span class="status-icon status-delivered">âœ“âœ“</span>';
                case 'read':
                    return '<span class="status-icon status-read">âœ“âœ“</span>';
                case 'failed':
                    return '<span class="status-icon status-failed">âš </span>';
                default:
                    return '<span class="status-icon status-pending">â—‹</span>';
            }
        }

        // Slash command menu functions
        function showSlashCommandMenu(query) {
            fetch(`/api/canned-responses?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(commands => {
                    slashCommands = commands;
                    selectedCommandIndex = commands.length > 0 ? 0 : -1;
                    slashCommandActive = commands.length > 0;
                    renderSlashCommandMenu();
                })
                .catch(err => console.error('Error fetching slash commands:', err));
        }

        function renderSlashCommandMenu() {
            const menu = document.getElementById('slashCommandMenu');
            if (!slashCommandActive || slashCommands.length === 0) {
                menu.style.display = 'none';
                return;
            }

            menu.innerHTML = '';
            menu.style.display = 'block';

            const title = document.createElement('div');
            title.className = 'slash-command-title';
            title.textContent = 'Comandi rapidi:';
            menu.appendChild(title);

            slashCommands.forEach((cmd, index) => {
                const item = document.createElement('div');
                item.className = 'slash-command-item';
                if (index === selectedCommandIndex) {
                    item.classList.add('selected');
                }

                item.innerHTML = `
                    <div class="slash-command-shortcut">${cmd.shortcut}</div>
                    <div class="slash-command-label">${cmd.label}</div>
                `;

                item.onclick = () => selectSlashCommand(cmd);
                menu.appendChild(item);
            });
        }

        function selectSlashCommand(command) {
            const input = document.getElementById('messageInput');
            if (input && command) {
                input.value = command.message;
                input.dispatchEvent(new Event('input'));
                hideSlashCommandMenu();
                input.focus();
            }
        }

        function hideSlashCommandMenu() {
            slashCommandActive = false;
            slashCommands = [];
            selectedCommandIndex = -1;
            const menu = document.getElementById('slashCommandMenu');
            if (menu) {
                menu.style.display = 'none';
                menu.innerHTML = '';
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="text-center text-muted mt-5">Nessun messaggio</div>';
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            const dayKey = (d) => {
                const dt = new Date(d);
                return `${dt.getFullYear()}-${(dt.getMonth()+1).toString().padStart(2,'0')}-${dt.getDate().toString().padStart(2,'0')}`;
            };

            const formatDayLabel = (d) => {
                const dt = new Date(d);
                const midnight = new Date(dt);
                midnight.setHours(0,0,0,0);
                if (midnight.getTime() === today.getTime()) return 'Oggi';
                if (midnight.getTime() === yesterday.getTime()) return 'Ieri';
                return new Intl.DateTimeFormat('it-IT', { day: 'numeric', month: 'short', year: 'numeric' }).format(dt);
            };

            let currentDay = null;

            messages.forEach((msg, i) => {
                // Use created_at for audio messages, timestamp for text messages
                const msgTimestamp = msg.timestamp || msg.created_at;
                const key = dayKey(msgTimestamp);
                if (key !== currentDay) {
                    currentDay = key;
                    const sep = document.createElement('div');
                    sep.className = 'day-separator';
                    sep.setAttribute('data-label', formatDayLabel(msgTimestamp));
                    container.appendChild(sep);
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === 'bot' ? 'sent' : 'received'}`;
                // Add data-msg-id attribute for status updates
                if (msg.whatsapp_message_id) {
                    messageDiv.setAttribute('data-msg-id', msg.whatsapp_message_id);
                }

                const time = new Date(msgTimestamp).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});

                // Render audio, image, or text message
                if (msg.type === 'audio') {
                    // Handle both Windows (\) and Unix (/) path separators
                    const filename = msg.file_path.split(/[/\\]/).pop();
                    const voiceLabel = msg.is_voice ? 'Messaggio vocale' : 'File audio';
                    messageDiv.innerHTML = `
                        <div class="message-bubble audio-message">
                            <div class="audio-header">
                                <span class="audio-icon">ðŸŽ¤</span>
                                <span class="audio-label">${voiceLabel}</span>
                            </div>
                            <audio controls preload="metadata" class="audio-player">
                                <source src="/audio/${filename}" type="${msg.mime_type}">
                                Your browser does not support audio playback.
                            </audio>
                            <small class="message-time">${time}</small>
                        </div>
                    `;
                } else if (msg.type === 'image') {
                    // Extract filename from file_path
                    const filename = msg.file_path.split(/[/\\]/).pop();
                    // Use currentPhone from the outer scope instead of msg.phone_number
                    const imageUrl = `/images/${currentPhone}/${filename}`;

                    console.log('Image message:', {
                        file_path: msg.file_path,
                        filename: filename,
                        currentPhone: currentPhone,
                        imageUrl: imageUrl
                    });

                    // Show caption if present
                    const captionHtml = msg.caption ? `<div class="image-caption">${formatWhatsAppMessage(msg.caption)}</div>` : '';

                    messageDiv.innerHTML = `
                        <div class="message-bubble image-message">
                            <img src="${imageUrl}" alt="Image" class="chat-image" loading="lazy" onerror="console.error('Failed to load image:', this.src)" />
                            ${captionHtml}
                            <small class="message-time">${time}</small>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-bubble">
                            <div>${formatWhatsAppMessage(msg.message)}</div>
                            <small class="message-time">${time} ${renderStatusIcon(msg.status, msg.sender)}</small>
                        </div>
                    `;
                }
                // Animate only the last few messages for subtlety
                if (i >= messages.length - 5) {
                    messageDiv.classList.add('appear');
                }
                container.appendChild(messageDiv);
            });

            // Track rendered count and last day key for incremental appends
            renderedCountByPhone[currentPhone] = messages.length;
            lastDayKeyByPhone[currentPhone] = currentDay;

            // Scroll to bottom (smooth, respecting reduced motion)
            const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReduced) {
                container.scrollTop = container.scrollHeight;
            } else {
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }
        }

        // Append only new messages without re-rendering the entire list
        function appendNewMessages(messages) {
            const container = document.getElementById('messagesContainer');
            const start = renderedCountByPhone[currentPhone] || 0;
            if (!messages || messages.length <= start) return;

            // Local helpers (duplication kept for clarity and isolation)
            const dk = (d) => {
                const dt = new Date(d);
                return `${dt.getFullYear()}-${(dt.getMonth()+1).toString().padStart(2,'0')}-${dt.getDate().toString().padStart(2,'0')}`;
            };
            const dayLabel = (d) => {
                const dt = new Date(d);
                const today = new Date(); today.setHours(0,0,0,0);
                const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                const midnight = new Date(dt); midnight.setHours(0,0,0,0);
                if (midnight.getTime() === today.getTime()) return 'Oggi';
                if (midnight.getTime() === yesterday.getTime()) return 'Ieri';
                return new Intl.DateTimeFormat('it-IT', { day: 'numeric', month: 'short', year: 'numeric' }).format(dt);
            };

            let currentDay = lastDayKeyByPhone[currentPhone] || null;

            messages.slice(start).forEach(msg => {
                // Use created_at for audio messages, timestamp for text messages
                const msgTimestamp = msg.timestamp || msg.created_at;
                const key = dk(msgTimestamp);
                if (key !== currentDay) {
                    currentDay = key;
                    const sep = document.createElement('div');
                    sep.className = 'day-separator';
                    sep.setAttribute('data-label', dayLabel(msgTimestamp));
                    container.appendChild(sep);
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === 'bot' ? 'sent' : 'received'} appear`;
                // Add data-msg-id attribute for status updates
                if (msg.whatsapp_message_id) {
                    messageDiv.setAttribute('data-msg-id', msg.whatsapp_message_id);
                }
                const time = new Date(msgTimestamp).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});

                // Render audio, image, or text message
                if (msg.type === 'audio') {
                    // Handle both Windows (\) and Unix (/) path separators
                    const filename = msg.file_path.split(/[/\\]/).pop();
                    const voiceLabel = msg.is_voice ? 'Messaggio vocale' : 'File audio';
                    messageDiv.innerHTML = `
                        <div class="message-bubble audio-message">
                            <div class="audio-header">
                                <span class="audio-icon">ðŸŽ¤</span>
                                <span class="audio-label">${voiceLabel}</span>
                            </div>
                            <audio controls preload="metadata" class="audio-player">
                                <source src="/audio/${filename}" type="${msg.mime_type}">
                                Your browser does not support audio playback.
                            </audio>
                            <small class="message-time">${time}</small>
                        </div>
                    `;
                } else if (msg.type === 'image') {
                    // Extract filename from file_path
                    const filename = msg.file_path.split(/[/\\]/).pop();
                    // Use currentPhone from the outer scope instead of msg.phone_number
                    const imageUrl = `/images/${currentPhone}/${filename}`;

                    console.log('Image message:', {
                        file_path: msg.file_path,
                        filename: filename,
                        currentPhone: currentPhone,
                        imageUrl: imageUrl
                    });

                    // Show caption if present
                    const captionHtml = msg.caption ? `<div class="image-caption">${formatWhatsAppMessage(msg.caption)}</div>` : '';

                    messageDiv.innerHTML = `
                        <div class="message-bubble image-message">
                            <img src="${imageUrl}" alt="Image" class="chat-image" loading="lazy" onerror="console.error('Failed to load image:', this.src)" />
                            ${captionHtml}
                            <small class="message-time">${time}</small>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-bubble">
                            <div>${formatWhatsAppMessage(msg.message)}</div>
                            <small class="message-time">${time} ${renderStatusIcon(msg.status, msg.sender)}</small>
                        </div>
                    `;
                }
                container.appendChild(messageDiv);
            });

            // Update counters
            renderedCountByPhone[currentPhone] = messages.length;
            lastDayKeyByPhone[currentPhone] = dk(messages[messages.length - 1].timestamp);

            // Smooth scroll to bottom (respect reduced motion)
            const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReduced) {
                container.scrollTop = container.scrollHeight;
            } else {
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }
        }

        // Update message statuses in the DOM without re-rendering
        function updateMessageStatuses() {
            if (!currentPhone) return;

            fetch(`/api/message-statuses/${currentPhone}`)
                .then(response => response.json())
                .then(statuses => {
                    statuses.forEach(statusData => {
                        const msgId = statusData.whatsapp_message_id;
                        const newStatus = statusData.status;

                        // Find message element by data-msg-id
                        const messageEl = document.querySelector(`[data-msg-id="${msgId}"]`);
                        if (messageEl) {
                            // Find the status icon span within this message
                            const statusIcon = messageEl.querySelector('.status-icon');
                            if (statusIcon) {
                                // Update the status icon HTML
                                const newIconHTML = renderStatusIcon(newStatus, 'bot');
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = newIconHTML;
                                const newIcon = tempDiv.firstChild;

                                if (newIcon) {
                                    statusIcon.replaceWith(newIcon);
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('Error updating message statuses:', error));
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            const message = input.value.trim();
            if (!message || !currentPhone) return;
            if (sendBtn) sendBtn.disabled = true;

            fetch('/api/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phone: currentPhone,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    input.style.height = 'auto';
                    loadMessages(currentPhone, false, true);
                    // Manuale is auto-enabled on manual send; refresh toggle and draft
                    fetchSettingsAndDraft();
                } else {
                    alert('Errore nell\'invio del messaggio');
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Errore nell\'invio del messaggio');
            })
            .finally(() => {
                if (sendBtn) sendBtn.disabled = !input.value.trim();
            });
        }
        
        function openEditModal() {
            if (!currentPhone) return;
            
            // Load current profile data
            fetch(`/api/profile/${currentPhone}`)
                .then(response => response.json())
                .then(data => {
                    // Pre-fill form with existing data
                    const phoneSpan = document.getElementById('editPhoneText');
                    if (phoneSpan) phoneSpan.textContent = currentPhone;
                    document.getElementById('editName').value = data.name || '';
                    document.getElementById('editLastName').value = data.last_name || '';
                    document.getElementById('editCompany').value = data.ragione_sociale || '';
                    document.getElementById('editEmail').value = data.email || '';
                    if (document.getElementById('editNotes')) {
                        document.getElementById('editNotes').value = data.notes || '';
                    }
                    
                    // Reset alerts
                    document.getElementById('saveSuccess').classList.add('d-none');
                    document.getElementById('saveError').classList.add('d-none');
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editContactModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading profile:', error);
                });
        }
        
        function saveContact() {
            const saveButton = document.getElementById('saveButton');
            const saveButtonText = document.getElementById('saveButtonText');
            const saveSpinner = document.getElementById('saveSpinner');
            
            // Show loading state
            saveButton.disabled = true;
            saveButtonText.classList.add('d-none');
            saveSpinner.classList.remove('d-none');
            
            // Get form data
            const profileData = {
                name: document.getElementById('editName').value.trim(),
                last_name: document.getElementById('editLastName').value.trim(),
                ragione_sociale: document.getElementById('editCompany').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                notes: (document.getElementById('editNotes') ? document.getElementById('editNotes').value : '')
            };
            
            // Send update request
            fetch(`/api/profile/${currentPhone}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(profileData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    document.getElementById('saveSuccess').classList.remove('d-none');
                    document.getElementById('saveError').classList.add('d-none');
                    
                    // Update UI
                    loadConversations();
                    fetchSettingsAndDraft();
                    
                    // Close modal after delay
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editContactModal'));
                        modal.hide();
                    }, 1500);
                } else {
                    // Show error
                    document.getElementById('saveError').classList.remove('d-none');
                    document.getElementById('saveSuccess').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error saving profile:', error);
                document.getElementById('saveError').classList.remove('d-none');
                document.getElementById('saveSuccess').classList.add('d-none');
            })
            .finally(() => {
                // Reset button state
                saveButton.disabled = false;
                saveButtonText.classList.remove('d-none');
                saveSpinner.classList.add('d-none');
            });
        }

        // Manuale toggle and draft panel logic
        function onManualToggleChange() {
            if (!currentPhone) return;
            const checked = document.getElementById('manualToggle').checked;
            fetch(`/api/settings/${currentPhone}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ manual_mode: !!checked })
            }).then(() => {
                // When turning off, hide draft panel
                if (!checked) {
                    hideDraftPanel();
                } else {
                    // When turning on, fetch any existing draft
                    fetchDraft();
                }
            }).catch(err => console.error('Error updating settings:', err));
        }

        function setManualToggle(checked) {
            const el = document.getElementById('manualToggle');
            if (el) el.checked = !!checked;
        }

        function fetchSettingsAndDraft() {
            if (!currentPhone) return;
            fetch(`/api/settings/${currentPhone}`)
                .then(r => r.json())
                .then(s => {
                    const isManual = !!s.manual_mode;
                    setManualToggle(isManual);
                    if (isManual) {
                        // Avoid rerendering draft while user is typing or regenerating
                        if (!draftPanelState.isTyping && !draftPanelState.isRegenerating) {
                            fetchDraft();
                        }
                    } else {
                        hideDraftPanel();
                    }
                })
                .catch(err => console.error('Error fetching settings:', err));
        }

        function fetchDraft() {
            if (!currentPhone) return;
            fetch(`/api/draft/${currentPhone}`)
                .then(r => r.json())
                .then(d => {
                    if (d && d.draft) {
                        showDraftPanel(d.draft, d.created_at);
                    } else {
                        hideDraftPanel();
                    }
                })
                .catch(err => console.error('Error fetching draft:', err));
        }

        function showDraftPanel(text, createdAt) {
            const container = document.getElementById('draftPanelContainer');
            if (!container) return;
            container.style.display = 'block';

            // Build static structure each time for simplicity
            container.innerHTML = '';
            const title = document.createElement('div');
            title.className = 'd-flex justify-content-between align-items-center mb-2';
            title.innerHTML = `<strong>Bozza AI (Manuale)</strong>`;
            container.appendChild(title);

            const body = document.createElement('div');
            body.style.whiteSpace = 'pre-wrap';
            body.className = 'p-2 mb-2 draft-body';
            body.textContent = text; // safe: no innerHTML
            container.appendChild(body);

            const actions = document.createElement('div');
            actions.className = 'd-flex gap-2 align-items-center flex-wrap';
            actions.innerHTML = `
                <button class="btn btn-outline-primary btn-sm" id="btnInsertDraft">Inserisci nel messaggio</button>
                <button class="btn btn-outline-secondary btn-sm" id="btnRegenerate">Rigenera</button>
                <button class="btn btn-outline-danger btn-sm" id="btnDiscard">Scarta</button>
            `;
            container.appendChild(actions);

            const regenWrap = document.createElement('div');
            regenWrap.className = 'mt-2';
            regenWrap.style.display = draftPanelState.regenOpen ? 'block' : 'none';
            regenWrap.innerHTML = `
                <label class="form-label small">Aggiungi informazioni</label>
                <textarea class="form-control form-control-sm regen-notes" id="regenNotes" rows="2" placeholder="Dettagli aggiuntivi per migliorare la bozza"></textarea>
                <div class="mt-2 d-flex gap-2">
                    <button class="btn btn-primary btn-sm" id="btnConfirmRegenerate">Rigenera</button>
                    <button class="btn btn-light btn-sm" id="btnCancelRegenerate">Annulla</button>
                </div>
            `;
            container.appendChild(regenWrap);

            // Wire actions
            document.getElementById('btnInsertDraft').onclick = () => {
                // Hide draft panel FIRST to prevent layout overflow when inserting large text
                hideDraftPanel();

                const input = document.getElementById('messageInput');
                if (input) {
                    input.value = text;
                    input.dispatchEvent(new Event('input'));
                }
                // Clear draft in database
                fetch(`/api/draft/${currentPhone}/clear`, { method: 'POST' });
            };
            document.getElementById('btnRegenerate').onclick = () => {
                draftPanelState.regenOpen = true;
                regenWrap.style.display = 'block';
                const el = document.getElementById('regenNotes');
                if (el) {
                    el.focus();
                    const v = el.value; el.setSelectionRange(v.length, v.length);
                }
            };
            document.getElementById('btnCancelRegenerate').onclick = () => {
                draftPanelState.regenOpen = false;
                regenWrap.style.display = 'none';
            };
            const notesEl = document.getElementById('regenNotes');
            if (notesEl) {
                notesEl.value = draftPanelState.regenNotes || '';
                notesEl.addEventListener('input', () => {
                    draftPanelState.regenNotes = notesEl.value;
                });
                notesEl.addEventListener('focus', () => { draftPanelState.isTyping = true; });
                notesEl.addEventListener('blur', () => { draftPanelState.isTyping = false; });
                // If user was typing when rerendered, restore focus and caret
                if (draftPanelState.isTyping) {
                    notesEl.focus();
                    const v = notesEl.value; notesEl.setSelectionRange(v.length, v.length);
                }
            }
            document.getElementById('btnConfirmRegenerate').onclick = () => {
                const notes = (document.getElementById('regenNotes').value || '').trim();
                const confirmBtn = document.getElementById('btnConfirmRegenerate');
                const cancelBtn = document.getElementById('btnCancelRegenerate');
                const notesBox = document.getElementById('regenNotes');
                // Set loading state
                draftPanelState.isRegenerating = true;
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sto pensandoâ€¦';
                }
                if (cancelBtn) cancelBtn.disabled = true;
                if (notesBox) notesBox.disabled = true;

                fetch(`/api/draft/${currentPhone}/regenerate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ regenerate_notes: notes })
                })
                .then(r => r.json())
                .then(res => {
                    if (res && res.success && res.draft) {
                        // After regenerate, reset notes field but keep panel visible
                        draftPanelState = { regenOpen: false, regenNotes: '', isTyping: false, isRegenerating: false };
                        showDraftPanel(res.draft, null);
                    }
                })
                .catch(err => {
                    console.error('Error regenerating draft:', err);
                    // Restore UI state on failure
                    draftPanelState.isRegenerating = false;
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Rigenera';
                    }
                    if (cancelBtn) cancelBtn.disabled = false;
                    if (notesBox) notesBox.disabled = false;
                });
            };
            document.getElementById('btnDiscard').onclick = () => {
                fetch(`/api/draft/${currentPhone}/clear`, { method: 'POST' })
                    .then(() => { draftPanelState = { regenOpen: false, regenNotes: '' }; hideDraftPanel(); })
                    .catch(() => { draftPanelState = { regenOpen: false, regenNotes: '' }; hideDraftPanel(); });
            };
        }

        function hideDraftPanel() {
            const container = document.getElementById('draftPanelContainer');
            if (!container) return;
            container.style.display = 'none';
            container.innerHTML = '';
            draftPanelState = { regenOpen: false, regenNotes: '' };
        }
    </script>
</body>
</html>
