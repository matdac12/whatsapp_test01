<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Left Sidebar - Contact List -->
            <div class="col-md-4 col-lg-3 border-end p-0 contacts-sidebar">
                <div class="bg-light p-3 border-bottom">
                    <h5 class="mb-2">Conversazioni</h5>
                    <input type="text" id="contactsSearch" class="form-control form-control-sm contacts-search" placeholder="Cerca nome, azienda, telefono…" autocomplete="off">
                </div>
                <div class="contacts-list" id="contactsList">
                    <!-- Contacts will be loaded here -->
                </div>
            </div>
            
            <!-- Right Panel - Chat -->
            <div class="col-md-8 col-lg-9 p-0 d-flex flex-column">
                <!-- Chat Header -->
                <div class="chat-header bg-light p-3 border-bottom" id="chatHeader">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-0">
                                <span id="contactName" style="cursor: pointer;" onclick="if(currentPhone) openEditModal()">Seleziona una conversazione</span>
                                <i class="bi bi-pencil-square ms-2" style="font-size: 0.8em; cursor: pointer; display: none;" id="editIcon" onclick="openEditModal()"></i>
                            </h6>
                            <small class="text-muted" id="contactInfo"></small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="form-check form-switch mb-0" title="Quando attivo, le risposte AI vengono salvate come bozze">
                                <input class="form-check-input" type="checkbox" id="manualToggle" onchange="onManualToggleChange()">
                                <label class="form-check-label" for="manualToggle">Manuale</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div class="flex-grow-1 overflow-auto p-3 messages-container" id="messagesContainer">
                    <div class="text-center text-muted mt-5">
                        <p>Seleziona una conversazione dalla lista</p>
                    </div>
                </div>
                
                <!-- AI Draft Panel (Manuale) -->
                <div id="draftPanelContainer" class="draft-panel p-3 border-top" style="display: none; background: var(--panel-soft);"></div>

                <!-- Message Input -->
                <div class="border-top p-3 message-input-container" id="messageInputContainer" style="display: none;">
                    <div class="input-group">
                        <textarea rows="1" class="form-control" id="messageInput" placeholder="Scrivi un messaggio…"></textarea>
                        <button class="btn btn-success" id="sendButton" onclick="sendMessage()" disabled>Invia</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Contact Modal -->
    <div class="modal fade" id="editContactModal" tabindex="-1" aria-labelledby="editContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editContactModalLabel">Modifica Contatto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="contact-meta mb-3">
                        <div class="meta-item">
                            <i class="bi bi-telephone"></i>
                            <span class="meta-label">Numero</span>
                            <span class="meta-value">+<span id="editPhoneText"></span></span>
                        </div>
                    </div>
                    <form id="editContactForm">
                        <div class="mb-3">
                            <label for="editName" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="editName" placeholder="Inserisci nome">
                        </div>
                        <div class="mb-3">
                            <label for="editLastName" class="form-label">Cognome</label>
                            <input type="text" class="form-control" id="editLastName" placeholder="Inserisci cognome">
                        </div>
                        <div class="mb-3">
                            <label for="editCompany" class="form-label">Azienda (Ragione Sociale)</label>
                            <input type="text" class="form-control" id="editCompany" placeholder="Inserisci azienda">
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" placeholder="Inserisci email">
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Note</label>
                            <textarea class="form-control" id="editNotes" rows="3" placeholder="Note per questo contatto (visibili solo agli operatori)"></textarea>
                        </div>
                    </form>
                    <div class="alert alert-success d-none" id="saveSuccess">
                        <i class="bi bi-check-circle"></i> Contatto salvato con successo!
                    </div>
                    <div class="alert alert-danger d-none" id="saveError">
                        <i class="bi bi-exclamation-circle"></i> Errore nel salvataggio.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveContact()" id="saveButton">
                        <span id="saveButtonText">Salva</span>
                        <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPhone = null;
        let conversations = {};
        let contactsQuery = '';
        let composerInitialized = false;
        // Incremental update state
        const lastKnownTsByPhone = {};
        const renderedCountByPhone = {};
        const lastDayKeyByPhone = {};
        // Draft panel UI state to preserve regen section visibility and text
        let draftPanelState = { regenOpen: false, regenNotes: '', isTyping: false, isRegenerating: false };

        function initComposerListeners() {
            if (composerInitialized) return;
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            if (!input || !sendBtn) return;

            const autoResize = () => {
                input.style.height = 'auto';
                const maxH = 160; // px
                input.style.height = Math.min(input.scrollHeight, maxH) + 'px';
            };

            input.addEventListener('input', () => {
                const hasText = input.value.trim().length > 0;
                sendBtn.disabled = !hasText;
                autoResize();
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (input.value.trim()) {
                        sendMessage();
                    }
                }
            });

            // Initialize state
            autoResize();
            sendBtn.disabled = true;
            composerInitialized = true;
        }
        
        // Load conversations on page load
        window.onload = function() {
            loadConversations();
            setInterval(loadConversations, 5000); // Refresh every 5 seconds
            initComposerListeners();
            const search = document.getElementById('contactsSearch');
            if (search) {
                search.addEventListener('input', () => {
                    contactsQuery = search.value || '';
                    updateContactsList();
                });
            }
        };
        
        function loadConversations() {
            const contactsList = document.getElementById('contactsList');
            if (contactsList && contactsList.children.length === 0) {
                contactsList.setAttribute('aria-busy', 'true');
                contactsList.innerHTML = renderContactsSkeleton();
            }
            fetch('/api/conversations')
                .then(response => response.json())
                .then(data => {
                    conversations = data;
                    updateContactsList();
                    if (contactsList) contactsList.removeAttribute('aria-busy');
                    if (currentPhone) {
                        const newTs = conversations[currentPhone] ? conversations[currentPhone].last_timestamp : null;
                        if (renderedCountByPhone[currentPhone] != null && newTs && lastKnownTsByPhone[currentPhone] !== newTs) {
                            loadMessages(currentPhone, false, true); // incremental append
                        }
                        if (newTs) lastKnownTsByPhone[currentPhone] = newTs;
                        // Refresh settings/draft periodically to reflect new incoming drafts
                        fetchSettingsAndDraft();
                    }
                })
                .catch(error => console.error('Error loading conversations:', error));
        }
        
        // Helpers for contact timestamp sorting/formatting
        function parseTs(ts) {
            if (!ts) return null;
            const s = typeof ts === 'string' ? ts.replace(' ', 'T') : ts;
            const d = new Date(s);
            return isNaN(d) ? null : d;
        }

        function friendlyTimestamp(ts) {
            const dt = parseTs(ts);
            if (!dt) return '';
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const midnight = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
            const time = dt.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            if (midnight.getTime() === today.getTime()) return `Oggi ${time}`;
            if (midnight.getTime() === yesterday.getTime()) return `Ieri ${time}`;
            const sameYear = dt.getFullYear() === now.getFullYear();
            const fmt = new Intl.DateTimeFormat('it-IT', sameYear ? { day: 'numeric', month: 'short' } : { day: 'numeric', month: 'short', year: 'numeric' });
            return fmt.format(dt);
        }

        function updateContactsList() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';

            const entries = Object.entries(conversations);
            const q = (contactsQuery || '').trim().toLowerCase();
            let filtered = q ? entries.filter(([phone, info]) => {
                const dn = (info.name || `+${phone}`).toLowerCase();
                const company = (info.company || '').toLowerCase();
                const email = (info.email || '').toLowerCase();
                const last = (info.last_message || '').toLowerCase();
                return dn.includes(q) || company.includes(q) || email.includes(q) || phone.includes(q) || last.includes(q);
            }) : entries;

            // Sort by most recent last_timestamp descending
            filtered = filtered.sort(([, a], [, b]) => {
                const da = parseTs(a.last_timestamp);
                const db = parseTs(b.last_timestamp);
                const ta = da ? da.getTime() : 0;
                const tb = db ? db.getTime() : 0;
                return tb - ta;
            });

            if (filtered.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'p-3 text-muted';
                empty.textContent = 'Nessun risultato';
                contactsList.appendChild(empty);
                return;
            }

            for (const [phone, info] of filtered) {
                const contact = document.createElement('div');
                contact.className = 'contact-item p-3 border-bottom';
                if (phone === currentPhone) {
                    contact.classList.add('active');
                }

                const displayName = info.name || `+${phone}`;
                const lastMessage = info.last_message || '';
                const timestamp = info.last_timestamp ? friendlyTimestamp(info.last_timestamp) : '';

                contact.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="contact-title">
                            <span class="contact-name">${displayName}</span>
                            ${info.company ? `<small class="text-muted"> - ${info.company}</small>` : ''}
                        </div>
                        <small class="text-muted">${timestamp}</small>
                    </div>
                    <div class="contact-preview text-muted small">${lastMessage}</div>
                `;

                contact.onclick = () => selectContact(phone, contact);
                contactsList.appendChild(contact);
            }
        }
        
        function selectContact(phone, el) {
            currentPhone = phone;
            loadMessages(phone, true);
            
            // Update header
            const info = conversations[phone];
            document.getElementById('contactName').textContent = info.name || `+${phone}`;
            document.getElementById('contactInfo').textContent = `+${phone}`;
            document.getElementById('editIcon').style.display = 'inline';
            
            // Show message input
            document.getElementById('messageInputContainer').style.display = 'block';
            composerInitialized = false; // re-bind if needed after becoming visible
            initComposerListeners();
            // Autofocus composer and place caret at end
            const input = document.getElementById('messageInput');
            if (input) {
                setTimeout(() => {
                    input.focus();
                    const val = input.value;
                    input.value = '';
                    input.value = val;
                }, 0);
            }
            
            // Fetch settings and any existing draft
            fetchSettingsAndDraft();

            // Update active contact
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            if (el) el.classList.add('active');
        }
        
        function loadMessages(phone, showSkeleton = false, incremental = false) {
            const container = document.getElementById('messagesContainer');
            if (showSkeleton && container && !incremental) {
                container.setAttribute('aria-busy', 'true');
                container.innerHTML = renderMessagesSkeleton();
            }
            fetch(`/api/messages/${phone}`)
                .then(response => response.json())
                .then(messages => {
                    if (incremental && renderedCountByPhone[phone] != null) {
                        appendNewMessages(messages);
                    } else {
                        displayMessages(messages);
                    }
                })
                .catch(error => console.error('Error loading messages:', error))
                .finally(() => { if (container) container.removeAttribute('aria-busy'); });
        }

        // Skeleton generators
        function renderContactsSkeleton(count = 6) {
            let html = '';
            for (let i = 0; i < count; i++) {
                html += `
                <div class="contact-item p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="skeleton skeleton-line s16 w-50"></div>
                        <div class="skeleton skeleton-line s12 w-25"></div>
                    </div>
                    <div class="skeleton skeleton-line s12 w-75"></div>
                </div>`;
            }
            return html;
        }

        function renderMessagesSkeleton(count = 4) {
            let html = '';
            for (let i = 0; i < count; i++) {
                const align = i % 2 === 0 ? 'received' : 'sent';
                html += `
                <div class="message ${align}">
                    <div class="message-bubble">
                        <div class="skeleton skeleton-line s16 ${align === 'sent' ? 'w-50' : 'w-65'}"></div>
                        <div class="skeleton skeleton-line s12 ${align === 'sent' ? 'w-35' : 'w-50'} mt-2"></div>
                    </div>
                </div>`;
            }
            return html;
        }
        
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="text-center text-muted mt-5">Nessun messaggio</div>';
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            const dayKey = (d) => {
                const dt = new Date(d);
                return `${dt.getFullYear()}-${(dt.getMonth()+1).toString().padStart(2,'0')}-${dt.getDate().toString().padStart(2,'0')}`;
            };

            const formatDayLabel = (d) => {
                const dt = new Date(d);
                const midnight = new Date(dt);
                midnight.setHours(0,0,0,0);
                if (midnight.getTime() === today.getTime()) return 'Oggi';
                if (midnight.getTime() === yesterday.getTime()) return 'Ieri';
                return new Intl.DateTimeFormat('it-IT', { day: 'numeric', month: 'short', year: 'numeric' }).format(dt);
            };

            let currentDay = null;

            messages.forEach((msg, i) => {
                const key = dayKey(msg.timestamp);
                if (key !== currentDay) {
                    currentDay = key;
                    const sep = document.createElement('div');
                    sep.className = 'day-separator';
                    sep.setAttribute('data-label', formatDayLabel(msg.timestamp));
                    container.appendChild(sep);
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === 'bot' ? 'sent' : 'received'}`;

                const time = new Date(msg.timestamp).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});

                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        <div>${msg.message}</div>
                        <small class="message-time">${time}</small>
                    </div>
                `;
                // Animate only the last few messages for subtlety
                if (i >= messages.length - 5) {
                    messageDiv.classList.add('appear');
                }
                container.appendChild(messageDiv);
            });

            // Track rendered count and last day key for incremental appends
            renderedCountByPhone[currentPhone] = messages.length;
            lastDayKeyByPhone[currentPhone] = currentDay;

            // Scroll to bottom (smooth, respecting reduced motion)
            const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReduced) {
                container.scrollTop = container.scrollHeight;
            } else {
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }
        }

        // Append only new messages without re-rendering the entire list
        function appendNewMessages(messages) {
            const container = document.getElementById('messagesContainer');
            const start = renderedCountByPhone[currentPhone] || 0;
            if (!messages || messages.length <= start) return;

            // Local helpers (duplication kept for clarity and isolation)
            const dk = (d) => {
                const dt = new Date(d);
                return `${dt.getFullYear()}-${(dt.getMonth()+1).toString().padStart(2,'0')}-${dt.getDate().toString().padStart(2,'0')}`;
            };
            const dayLabel = (d) => {
                const dt = new Date(d);
                const today = new Date(); today.setHours(0,0,0,0);
                const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                const midnight = new Date(dt); midnight.setHours(0,0,0,0);
                if (midnight.getTime() === today.getTime()) return 'Oggi';
                if (midnight.getTime() === yesterday.getTime()) return 'Ieri';
                return new Intl.DateTimeFormat('it-IT', { day: 'numeric', month: 'short', year: 'numeric' }).format(dt);
            };

            let currentDay = lastDayKeyByPhone[currentPhone] || null;

            messages.slice(start).forEach(msg => {
                const key = dk(msg.timestamp);
                if (key !== currentDay) {
                    currentDay = key;
                    const sep = document.createElement('div');
                    sep.className = 'day-separator';
                    sep.setAttribute('data-label', dayLabel(msg.timestamp));
                    container.appendChild(sep);
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === 'bot' ? 'sent' : 'received'} appear`;
                const time = new Date(msg.timestamp).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        <div>${msg.message}</div>
                        <small class="message-time">${time}</small>
                    </div>
                `;
                container.appendChild(messageDiv);
            });

            // Update counters
            renderedCountByPhone[currentPhone] = messages.length;
            lastDayKeyByPhone[currentPhone] = dk(messages[messages.length - 1].timestamp);

            // Smooth scroll to bottom (respect reduced motion)
            const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReduced) {
                container.scrollTop = container.scrollHeight;
            } else {
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            const message = input.value.trim();
            if (!message || !currentPhone) return;
            if (sendBtn) sendBtn.disabled = true;

            fetch('/api/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phone: currentPhone,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    input.style.height = 'auto';
                    loadMessages(currentPhone, false, true);
                    // Manuale is auto-enabled on manual send; refresh toggle and draft
                    fetchSettingsAndDraft();
                } else {
                    alert('Errore nell\'invio del messaggio');
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Errore nell\'invio del messaggio');
            })
            .finally(() => {
                if (sendBtn) sendBtn.disabled = !input.value.trim();
            });
        }
        
        function openEditModal() {
            if (!currentPhone) return;
            
            // Load current profile data
            fetch(`/api/profile/${currentPhone}`)
                .then(response => response.json())
                .then(data => {
                    // Pre-fill form with existing data
                    const phoneSpan = document.getElementById('editPhoneText');
                    if (phoneSpan) phoneSpan.textContent = currentPhone;
                    document.getElementById('editName').value = data.name || '';
                    document.getElementById('editLastName').value = data.last_name || '';
                    document.getElementById('editCompany').value = data.ragione_sociale || '';
                    document.getElementById('editEmail').value = data.email || '';
                    if (document.getElementById('editNotes')) {
                        document.getElementById('editNotes').value = data.notes || '';
                    }
                    
                    // Reset alerts
                    document.getElementById('saveSuccess').classList.add('d-none');
                    document.getElementById('saveError').classList.add('d-none');
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editContactModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading profile:', error);
                });
        }
        
        function saveContact() {
            const saveButton = document.getElementById('saveButton');
            const saveButtonText = document.getElementById('saveButtonText');
            const saveSpinner = document.getElementById('saveSpinner');
            
            // Show loading state
            saveButton.disabled = true;
            saveButtonText.classList.add('d-none');
            saveSpinner.classList.remove('d-none');
            
            // Get form data
            const profileData = {
                name: document.getElementById('editName').value.trim(),
                last_name: document.getElementById('editLastName').value.trim(),
                ragione_sociale: document.getElementById('editCompany').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                notes: (document.getElementById('editNotes') ? document.getElementById('editNotes').value : '')
            };
            
            // Send update request
            fetch(`/api/profile/${currentPhone}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(profileData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    document.getElementById('saveSuccess').classList.remove('d-none');
                    document.getElementById('saveError').classList.add('d-none');
                    
                    // Update UI
                    loadConversations();
                    fetchSettingsAndDraft();
                    
                    // Close modal after delay
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editContactModal'));
                        modal.hide();
                    }, 1500);
                } else {
                    // Show error
                    document.getElementById('saveError').classList.remove('d-none');
                    document.getElementById('saveSuccess').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error saving profile:', error);
                document.getElementById('saveError').classList.remove('d-none');
                document.getElementById('saveSuccess').classList.add('d-none');
            })
            .finally(() => {
                // Reset button state
                saveButton.disabled = false;
                saveButtonText.classList.remove('d-none');
                saveSpinner.classList.add('d-none');
            });
        }

        // Manuale toggle and draft panel logic
        function onManualToggleChange() {
            if (!currentPhone) return;
            const checked = document.getElementById('manualToggle').checked;
            fetch(`/api/settings/${currentPhone}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ manual_mode: !!checked })
            }).then(() => {
                // When turning off, hide draft panel
                if (!checked) {
                    hideDraftPanel();
                } else {
                    // When turning on, fetch any existing draft
                    fetchDraft();
                }
            }).catch(err => console.error('Error updating settings:', err));
        }

        function setManualToggle(checked) {
            const el = document.getElementById('manualToggle');
            if (el) el.checked = !!checked;
        }

        function fetchSettingsAndDraft() {
            if (!currentPhone) return;
            fetch(`/api/settings/${currentPhone}`)
                .then(r => r.json())
                .then(s => {
                    const isManual = !!s.manual_mode;
                    setManualToggle(isManual);
                    if (isManual) {
                        // Avoid rerendering draft while user is typing or regenerating
                        if (!draftPanelState.isTyping && !draftPanelState.isRegenerating) {
                            fetchDraft();
                        }
                    } else {
                        hideDraftPanel();
                    }
                })
                .catch(err => console.error('Error fetching settings:', err));
        }

        function fetchDraft() {
            if (!currentPhone) return;
            fetch(`/api/draft/${currentPhone}`)
                .then(r => r.json())
                .then(d => {
                    if (d && d.draft) {
                        showDraftPanel(d.draft, d.created_at);
                    } else {
                        hideDraftPanel();
                    }
                })
                .catch(err => console.error('Error fetching draft:', err));
        }

        function showDraftPanel(text, createdAt) {
            const container = document.getElementById('draftPanelContainer');
            if (!container) return;
            container.style.display = 'block';

            // Build static structure each time for simplicity
            container.innerHTML = '';
            const title = document.createElement('div');
            title.className = 'd-flex justify-content-between align-items-center mb-2';
            title.innerHTML = `<strong>Bozza AI (Manuale)</strong>`;
            container.appendChild(title);

            const body = document.createElement('div');
            body.style.whiteSpace = 'pre-wrap';
            body.style.maxHeight = '180px';
            body.style.overflowY = 'auto';
            body.className = 'p-2 mb-2 draft-body';
            body.textContent = text; // safe: no innerHTML
            container.appendChild(body);

            const actions = document.createElement('div');
            actions.className = 'd-flex gap-2 align-items-center flex-wrap';
            actions.innerHTML = `
                <button class="btn btn-outline-primary btn-sm" id="btnInsertDraft">Inserisci nel messaggio</button>
                <button class="btn btn-outline-secondary btn-sm" id="btnRegenerate">Rigenera</button>
                <button class="btn btn-outline-danger btn-sm" id="btnDiscard">Scarta</button>
            `;
            container.appendChild(actions);

            const regenWrap = document.createElement('div');
            regenWrap.className = 'mt-2';
            regenWrap.style.display = draftPanelState.regenOpen ? 'block' : 'none';
            regenWrap.innerHTML = `
                <label class="form-label small">Aggiungi informazioni</label>
                <textarea class="form-control form-control-sm regen-notes" id="regenNotes" rows="2" placeholder="Dettagli aggiuntivi per migliorare la bozza"></textarea>
                <div class="mt-2 d-flex gap-2">
                    <button class="btn btn-primary btn-sm" id="btnConfirmRegenerate">Rigenera</button>
                    <button class="btn btn-light btn-sm" id="btnCancelRegenerate">Annulla</button>
                </div>
            `;
            container.appendChild(regenWrap);

            // Wire actions
            document.getElementById('btnInsertDraft').onclick = () => {
                const input = document.getElementById('messageInput');
                if (input) {
                    input.value = text;
                    input.dispatchEvent(new Event('input'));
                }
                // Clear draft immediately after inserting
                fetch(`/api/draft/${currentPhone}/clear`, { method: 'POST' })
                    .finally(() => fetchDraft());
            };
            document.getElementById('btnRegenerate').onclick = () => {
                draftPanelState.regenOpen = true;
                regenWrap.style.display = 'block';
                const el = document.getElementById('regenNotes');
                if (el) {
                    el.focus();
                    const v = el.value; el.setSelectionRange(v.length, v.length);
                }
            };
            document.getElementById('btnCancelRegenerate').onclick = () => {
                draftPanelState.regenOpen = false;
                regenWrap.style.display = 'none';
            };
            const notesEl = document.getElementById('regenNotes');
            if (notesEl) {
                notesEl.value = draftPanelState.regenNotes || '';
                notesEl.addEventListener('input', () => {
                    draftPanelState.regenNotes = notesEl.value;
                });
                notesEl.addEventListener('focus', () => { draftPanelState.isTyping = true; });
                notesEl.addEventListener('blur', () => { draftPanelState.isTyping = false; });
                // If user was typing when rerendered, restore focus and caret
                if (draftPanelState.isTyping) {
                    notesEl.focus();
                    const v = notesEl.value; notesEl.setSelectionRange(v.length, v.length);
                }
            }
            document.getElementById('btnConfirmRegenerate').onclick = () => {
                const notes = (document.getElementById('regenNotes').value || '').trim();
                const confirmBtn = document.getElementById('btnConfirmRegenerate');
                const cancelBtn = document.getElementById('btnCancelRegenerate');
                const notesBox = document.getElementById('regenNotes');
                // Set loading state
                draftPanelState.isRegenerating = true;
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sto pensando…';
                }
                if (cancelBtn) cancelBtn.disabled = true;
                if (notesBox) notesBox.disabled = true;

                fetch(`/api/draft/${currentPhone}/regenerate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ regenerate_notes: notes })
                })
                .then(r => r.json())
                .then(res => {
                    if (res && res.success && res.draft) {
                        // After regenerate, reset notes field but keep panel visible
                        draftPanelState = { regenOpen: false, regenNotes: '', isTyping: false, isRegenerating: false };
                        showDraftPanel(res.draft, null);
                    }
                })
                .catch(err => {
                    console.error('Error regenerating draft:', err);
                    // Restore UI state on failure
                    draftPanelState.isRegenerating = false;
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Rigenera';
                    }
                    if (cancelBtn) cancelBtn.disabled = false;
                    if (notesBox) notesBox.disabled = false;
                });
            };
            document.getElementById('btnDiscard').onclick = () => {
                fetch(`/api/draft/${currentPhone}/clear`, { method: 'POST' })
                    .then(() => { draftPanelState = { regenOpen: false, regenNotes: '' }; hideDraftPanel(); })
                    .catch(() => { draftPanelState = { regenOpen: false, regenNotes: '' }; hideDraftPanel(); });
            };
        }

        function hideDraftPanel() {
            const container = document.getElementById('draftPanelContainer');
            if (!container) return;
            container.style.display = 'none';
            container.innerHTML = '';
            draftPanelState = { regenOpen: false, regenNotes: '' };
        }
    </script>
</body>
</html>
